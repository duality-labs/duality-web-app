name: Deploy Preview

on:
  pull_request_target:
    branches: [ main ]
    types: [ opened, reopened, edited, synchronize, labeled ]

jobs:
  build:
    # require 'deploy preview' label
    if: contains(github.event.pull_request.labels.*.name, 'deploy preview') 
    runs-on: ubuntu-latest

    steps:
    - name: Checkout branch head (not merged head)
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Update nvmrc
      # use basic regex to get Node engine version from package.json
      # will fail if not correctly specified
      run: node -p "require('./package.json').engines.node.match(/\d.*/)[0]" > .nvmrc

    - name: Deploy preview to Netlify
      id: netlify_deploy
      # see: https://github.com/marketplace/actions/netlify-deploy
      uses: jsmrcaga/action-netlify-deploy@v1.7.2
      with:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        NETLIFY_DEPLOY_MESSAGE: "Preview deploy v${{ github.ref }}"
        NETLIFY_DEPLOY_TO_PROD: false
        build_directory: build
        build_command: npm run build
        install_command: npm ci

    - name: Add comment to PR
      if: github.ref != 'refs/heads/main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # get deploy outputs: see https://github.com/marketplace/actions/netlify-deploy#outputs
      # get PR number: see https://github.com/actions/checkout/issues/58#issuecomment-812259610
      run: |
        echo "Preview URL: ${{ steps.netlify_deploy.outputs.NETLIFY_PREVIEW_URL }}" > netlify.txt
        echo "Logs: ${{ steps.netlify_deploy.outputs.NETLIFY_LOGS_URL }}" >> netlify.txt
        gh pr comment ${{ github.event.pull_request.number }} --body-file netlify.txt || true
